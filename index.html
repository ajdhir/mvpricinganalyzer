<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle MAP Price Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .file-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-drop {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background: #f7fafc;
            transition: all 0.3s;
        }
        
        .file-drop:hover {
            border-color: #667eea;
            background: #edf2ff;
        }
        
        .file-drop.loaded {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .file-drop h3 { color: #2d3748; margin-bottom: 10px; }
        .file-drop p { color: #718096; font-size: 0.9rem; }
        .file-name { margin-top: 10px; color: #48bb78; font-weight: 600; }
        
        input[type="file"] { display: none; }
        
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .results-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }
        
        .results-section.show { display: block; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover { background: #f7fafc; }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        th:hover {
            background: #e2e8f0;
        }
        
        th.sort-asc::after {
            content: ' â†‘';
            color: #667eea;
        }
        
        th.sort-desc::after {
            content: ' â†“';
            color: #667eea;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:hover { background: #f7fafc; }
        
        .status-above { color: #e53e3e; font-weight: 600; }
        .status-below { color: #48bb78; font-weight: 600; }
        .status-at { color: #718096; }
        
        .export-btn {
            background: #48bb78;
            color: white;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš— Vehicle MAP Price Analyzer</h1>
            <p>Compare current prices against MAP pricing</p>
        </div>
        
        <div class="upload-section">
            <div class="file-inputs">
                <div class="file-drop" id="bottomDrop" onclick="document.getElementById('bottomFile').click()">
                    <h3>ðŸ“Š Bottom Price File</h3>
                    <p>Drop Excel/CSV file or click to browse</p>
                    <p style="color: #667eea; font-size: 0.85rem; margin-top: 10px;">
                        VIN: Column E | Current Price: Column J
                    </p>
                    <input type="file" id="bottomFile" accept=".xlsx,.xls,.csv">
                    <div class="file-name" id="bottomName"></div>
                </div>
                
                <div class="file-drop" id="mapDrop" onclick="document.getElementById('mapFile').click()">
                    <h3>ðŸ“‹ MAP Details File</h3>
                    <p>Drop Excel/CSV file or click to browse</p>
                    <p style="color: #667eea; font-size: 0.85rem; margin-top: 10px;">
                        VIN: Column H | MAP Price: Column J
                    </p>
                    <input type="file" id="mapFile" accept=".xlsx,.xls,.csv">
                    <div class="file-name" id="mapName"></div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" id="analyzeBtn" disabled onclick="analyze()">
                    Analyze Pricing
                </button>
            </div>
        </div>
        
        <div class="results-section" id="results">
            <h2 style="margin-bottom: 20px;">Analysis Results</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalStat">0</div>
                    <div>Total Matched</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value status-above" id="aboveStat">0</div>
                    <div>Above MAP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value status-below" id="belowStat">0</div>
                    <div>Below MAP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value status-at" id="atStat">0</div>
                    <div>At MAP</div>
                </div>
            </div>
            
            <button class="btn export-btn" onclick="exportExcel()">ðŸ“¥ Export to Excel</button>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTable('all', this)">Show All</button>
                <button class="filter-btn" onclick="filterTable('above', this)">Above MAP Only</button>
                <button class="filter-btn" onclick="filterTable('below', this)">Below MAP Only</button>
                <button class="filter-btn" onclick="filterTable('at', this)">At MAP Only</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="margin-right: 10px; font-weight: 600;">Filter by Store:</label>
                <select id="storeFilter" onchange="applyFilters()" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="all">All Stores</option>
                </select>
            </div>
            
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Status</th>
                            <th onclick="sortTable(1)">Store</th>
                            <th onclick="sortTable(2)">VIN</th>
                            <th onclick="sortTable(3)">Current Price</th>
                            <th onclick="sortTable(4)">MAP Price</th>
                            <th onclick="sortTable(5)">Difference</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let bottomData = null;
        let mapData = null;
        let results = [];
        let currentStatusFilter = 'all';
        let currentStoreFilter = 'all';
        let currentSort = { column: -1, ascending: true };

        // Setup drag and drop
        ['bottomDrop', 'mapDrop'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('dragover', e => {
                e.preventDefault();
                el.style.borderColor = '#667eea';
            });
            el.addEventListener('dragleave', () => {
                el.style.borderColor = '#cbd5e0';
            });
            el.addEventListener('drop', e => {
                e.preventDefault();
                el.style.borderColor = '#cbd5e0';
                const file = e.dataTransfer.files[0];
                const input = id === 'bottomDrop' ? 'bottomFile' : 'mapFile';
                handleFile(file, input);
            });
        });

        // File input handlers
        document.getElementById('bottomFile').addEventListener('change', e => {
            if (e.target.files[0]) handleFile(e.target.files[0], 'bottomFile');
        });
        
        document.getElementById('mapFile').addEventListener('change', e => {
            if (e.target.files[0]) handleFile(e.target.files[0], 'mapFile');
        });

        function handleFile(file, inputId) {
            const reader = new FileReader();
            const isBottom = inputId === 'bottomFile';
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
                
                if (isBottom) {
                    bottomData = jsonData;
                    document.getElementById('bottomDrop').classList.add('loaded');
                    document.getElementById('bottomName').textContent = 'âœ“ ' + file.name;
                    
                    // Debug log
                    console.log('Bottom Price loaded:', jsonData.length, 'rows');
                    if (jsonData[1]) {
                        console.log('  Sample VIN (E):', jsonData[1][4]);
                        console.log('  Sample Price (J):', jsonData[1][9]);
                    }
                } else {
                    mapData = jsonData;
                    document.getElementById('mapDrop').classList.add('loaded');
                    document.getElementById('mapName').textContent = 'âœ“ ' + file.name;
                    
                    // Debug log
                    console.log('MAP Details loaded:', jsonData.length, 'rows');
                    if (jsonData[1]) {
                        console.log('  Sample VIN (H):', jsonData[1][7]);
                        console.log('  Sample Price (J):', jsonData[1][9]);
                    }
                }
                
                // Enable analyze button if both files loaded
                if (bottomData && mapData) {
                    document.getElementById('analyzeBtn').disabled = false;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function cleanPrice(val) {
            if (!val && val !== 0) return 0;
            if (typeof val === 'number') return val;
            const cleaned = String(val).replace(/[^0-9.-]/g, '');
            return parseFloat(cleaned) || 0;
        }

        function analyze() {
            console.log('\n=== STARTING ANALYSIS ===');
            results = [];
            
            // Build MAP lookup - Column H (7) for VIN, Column J (9) for price
            const mapLookup = {};
            console.log('Building MAP lookup from', mapData.length, 'rows');
            
            for (let i = 1; i < mapData.length; i++) {
                const row = mapData[i];
                if (!row) continue;
                
                // Column H = index 7
                const vin = String(row[7] || '').trim();
                // Column J = index 9
                const price = cleanPrice(row[9]);
                
                if (i <= 3) {
                    console.log(`MAP row ${i}: VIN(H)="${vin}", Price(J)="${row[9]}" => $${price}`);
                }
                
                if (vin && vin.length >= 17) {
                    mapLookup[vin] = price;
                }
            }
            
            console.log('MAP lookup built:', Object.keys(mapLookup).length, 'VINs');
            
            // Process Bottom Price - Column E (4) for VIN, Column J (9) for price
            let above = 0, below = 0, at = 0, notFound = 0;
            
            for (let i = 1; i < bottomData.length; i++) {
                const row = bottomData[i];
                if (!row) continue;
                
                // Column E = index 4
                const vin = String(row[4] || '').trim();
                // Column J = index 9
                const currentPrice = cleanPrice(row[9]);
                const store = row[0] || 'Unknown';
                
                if (i <= 3) {
                    console.log(`Bottom row ${i}: VIN(E)="${vin}", Price(J)="${row[9]}" => $${currentPrice}`);
                }
                
                if (!vin || vin.length < 17 || currentPrice <= 0) continue;
                
                const mapPrice = mapLookup[vin];
                
                if (mapPrice === undefined) {
                    notFound++;
                    if (notFound <= 3) console.log(`  VIN not found: ${vin}`);
                    continue;
                }
                
                const diff = currentPrice - mapPrice;
                let status = '';
                
                if (diff > 0) {
                    status = 'ABOVE';
                    above++;
                } else if (diff < 0) {
                    status = 'BELOW';
                    below++;
                } else {
                    status = 'AT';
                    at++;
                }
                
                results.push({
                    status: status,
                    store: store,
                    vin: vin,
                    currentPrice: currentPrice,
                    mapPrice: mapPrice,
                    difference: diff
                });
            }
            
            console.log(`\nResults: ${results.length} matched`);
            console.log(`Above: ${above}, Below: ${below}, At: ${at}`);
            console.log(`Not found in MAP: ${notFound}`);
            
            // Sort by difference (highest first)
            results.sort((a, b) => b.difference - a.difference);
            
            // Get unique stores for filter dropdown
            const stores = [...new Set(results.map(r => r.store))].sort();
            const storeSelect = document.getElementById('storeFilter');
            storeSelect.innerHTML = '<option value="all">All Stores</option>';
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
            });
            
            // Update display
            document.getElementById('totalStat').textContent = results.length;
            document.getElementById('aboveStat').textContent = above;
            document.getElementById('belowStat').textContent = below;
            document.getElementById('atStat').textContent = at;
            
            // Render table
            renderTable();
            
            document.getElementById('results').classList.add('show');
        }
        
        function renderTable(filteredResults = null) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const dataToRender = filteredResults || results;
            
            dataToRender.forEach(r => {
                const tr = document.createElement('tr');
                tr.dataset.status = r.status.toLowerCase();
                tr.dataset.store = r.store;
                
                let statusClass = 'status-at';
                let statusSymbol = 'âœ“';
                if (r.status === 'ABOVE') {
                    statusClass = 'status-above';
                    statusSymbol = 'â¬†';
                } else if (r.status === 'BELOW') {
                    statusClass = 'status-below';
                    statusSymbol = 'â¬‡';
                }
                
                tr.innerHTML = `
                    <td class="${statusClass}" data-sort="${r.status}">${statusSymbol} ${r.status}</td>
                    <td data-sort="${r.store}">${r.store}</td>
                    <td data-sort="${r.vin}">${r.vin}</td>
                    <td data-sort="${r.currentPrice}">${r.currentPrice.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                    <td data-sort="${r.mapPrice}">${r.mapPrice.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                    <td class="${statusClass}" data-sort="${r.difference}">
                        ${r.difference > 0 ? '+' : ''}${r.difference.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function filterTable(filter, btn) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Store current filter
            currentStatusFilter = filter;
            
            // Apply all filters
            applyFilters();
        }
        
        function applyFilters() {
            const storeFilter = document.getElementById('storeFilter').value;
            currentStoreFilter = storeFilter;
            
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                let showRow = true;
                
                // Apply status filter
                if (currentStatusFilter !== 'all' && row.dataset.status !== currentStatusFilter) {
                    showRow = false;
                }
                
                // Apply store filter
                if (storeFilter !== 'all' && row.dataset.store !== storeFilter) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        function sortTable(columnIndex) {
            // Update sort direction
            if (currentSort.column === columnIndex) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = columnIndex;
                currentSort.ascending = true;
            }
            
            // Update header indicators
            document.querySelectorAll('th').forEach((th, index) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (index === columnIndex) {
                    th.classList.add(currentSort.ascending ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Sort the results array
            const sortedResults = [...results].sort((a, b) => {
                let valA, valB;
                
                switch(columnIndex) {
                    case 0: // Status
                        valA = a.status;
                        valB = b.status;
                        break;
                    case 1: // Store
                        valA = a.store;
                        valB = b.store;
                        break;
                    case 2: // VIN
                        valA = a.vin;
                        valB = b.vin;
                        break;
                    case 3: // Current Price
                        valA = a.currentPrice;
                        valB = b.currentPrice;
                        break;
                    case 4: // MAP Price
                        valA = a.mapPrice;
                        valB = b.mapPrice;
                        break;
                    case 5: // Difference
                        valA = a.difference;
                        valB = b.difference;
                        break;
                    default:
                        return 0;
                }
                
                // Handle numeric vs string comparison
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSort.ascending ? valA - valB : valB - valA;
                } else {
                    // String comparison
                    if (valA < valB) return currentSort.ascending ? -1 : 1;
                    if (valA > valB) return currentSort.ascending ? 1 : -1;
                    return 0;
                }
            });
            
            // Re-render table with sorted data
            renderTable(sortedResults);
            
            // Re-apply filters after sorting
            applyFilters();
        }

        function exportExcel() {
            if (results.length === 0) {
                alert('No data to export');
                return;
            }
            
            const ws_data = [['Status', 'Store', 'VIN', 'Current Price', 'MAP Price', 'Difference']];
            results.forEach(r => {
                ws_data.push([r.status, r.store, r.vin, r.currentPrice, r.mapPrice, r.difference]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'MAP Analysis');
            XLSX.writeFile(wb, `MAP_Analysis_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>
